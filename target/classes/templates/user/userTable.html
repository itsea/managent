<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>User Table</title>
    <script th:src="@{/js/jquery-3.4.1.js}"></script>
    <script th:src="@{/layui/layui.js}"></script>
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}">
</head>
<body>

<!--搜索查询表单-->
<form class="layui-form" id="userSearchForm" action="">
    <br>
<div class="layui-form-item">
    <label class="layui-form-label">状态:</label>
    <div class="layui-input-inline">
        <select name="statusSearchSelect" id="statusSearchSelect">
            <option value="" selected="selected">所有</option>
            <option value="0">正常</option>
            <option value="1">受限</option>
        </select>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">登录名:</label>
        <div class="layui-input-inline">
            <input type="text" id="searchLoginName" name="searchLoginName" lay-verify="" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">电话号码:</label>
        <div class="layui-input-inline">
            <input id="searchPhoneNumber" type="text" name="searchPhoneNumber" lay-verify="" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-inline">
        <div class="layui-input-inline">
            <button id="searchButton" class="layui-btn"><i class="layui-icon layui-icon-search"></i>查询</button>
            <button type="reset" class="layui-btn layui-btn-primary"><i class="layui-icon layui-icon-refresh-1"></i>重置</button>
        </div>
    </div>
</div>
</form>

<hr>

<!--重置密码的表单-->
<form class="layui-form layui-form-pane" id="resetPasswordFormPage" action="" style="display: none;text-align: center" method="post">
    <br><br>
    <div class="layui-inline">
    <div class="layui-form-item" style="display: none" >
        <label class="layui-form-label">用户Id</label>
        <div class="layui-input-inline">
            <input id="resetPasswordPageUserId" type="text" name="userId" placeholder="请输入用户Id" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">新密码</label>
        <div class="layui-input-inline">
            <input type="password" name="newPassword" required lay-verify="required" placeholder="请输入新密码" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">确认密码</label>
        <div class="layui-input-inline">
            <input type="password" name="password" required lay-verify="required" placeholder="请再次确认密码" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="resetPasswordButton">确定</button>
            <button id="cancelResetPassword" class="layui-btn layui-btn-primary">取消</button>
        </div>
    </div>
    </div>
</form>

    <!--插入用户表单-->
    <form class="layui-form layui-form-pane" id="insertFormPage" action="" style="display: none;text-align: center" method="post">
        <br><br>
        <div class="layui-inline">
        <div class="layui-form-item">
            <label class="layui-form-label">登录名</label>
            <div class="layui-input-inline">
                <input type="text" name="loginName" required lay-verify="required" placeholder="请输入登录名" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">用户名</label>
            <div class="layui-input-inline">
                <input type="text" name="userName" required lay-verify="required" placeholder="请输入用户名" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">密  码</label>
            <div class="layui-input-inline">
                <input type="text" name="password" required lay-verify="required" placeholder="请输入密码" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">角  色</label>
            <div class="layui-input-inline">
                <select name="roleName" lay-verify="required" id="roleSelect">
                    <option value="">请选择角色</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">部  门</label>
            <div class="layui-input-inline">
                <select name="deptName" lay-verify="required" id="deptSelect">
                    <option value="">请选择部门</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">状态</label>
            <div class="layui-input-block">
                <input type="checkbox" name="status" lay-skin="switch" checked="checked" lay-text="正常|受限">
            </div>
        </div>
        <div class="layui-form-item" pane>
            <label class="layui-form-label">性  别</label>
            <div class="layui-input-block">
                <input type="radio" name="sex" value="男" title="男" checked>
                <input type="radio" name="sex" value="女" title="女">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">电话号码</label>
            <div class="layui-input-inline">
                <input type="text" name="phoneNumber" placeholder="请输入电话号码" lay-verify="phone" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">邮箱</label>
            <div class="layui-input-inline">
                <input type="text" name="email" placeholder="请输入邮箱地址" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="insertButton">插入</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
        </div>
    </form>

<!--编辑用户表单-->
<form class="layui-form layui-form-pane" id="editFormPage" action="" style="display: none;text-align: center" method="post" name="editFormPage">
    <br><br>
    <div class="layui-inline">
    <div class="layui-form-item" style="display: none">
        <label class="layui-form-label">用户Id</label>
        <div class="layui-input-inline">
            <input id="userId" type="text" name="userId" placeholder="请输入用户Id" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">登录名</label>
        <div class="layui-input-inline">
            <input id="loginName" type="text" name="loginName" required lay-verify="required" placeholder="请输入登录名" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">用户名</label>
        <div class="layui-input-inline">
            <input id="userName" type="text" name="userName" required lay-verify="required" placeholder="请输入用户名" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item" style="display:none">
        <label class="layui-form-label">密  码</label>
        <div class="layui-input-inline">
            <input type="text" name="password" placeholder="请输入密码" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">角  色</label>
        <div class="layui-input-inline">
            <select name="roleName" lay-verify="required" id="roleEditFormSelect">
                <option value="">请选择角色</option>
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">部  门</label>
        <div class="layui-input-inline">
            <select name="deptName" lay-verify="required" id="deptEditFormSelect">
                <option value="">请选择部门</option>
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">状态</label>
        <div class="layui-input-block" pane>
            <input type="checkbox" name="status" lay-skin="switch" id="statusCheckBox" lay-text="正常|受限">
        </div>
    </div>
    <div class="layui-form-item" pane>
        <label class="layui-form-label">性  别</label>
        <div class="layui-input-block">
            <input type="radio" name="sex" value="男" title="男" checked id="manSexEdit">
            <input type="radio" name="sex" value="女" title="女" id="femaleSexEdit">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">电话号码</label>
        <div class="layui-input-inline">
            <input type="text" name="phoneNumber" placeholder="请输入电话号码" lay-verify="phone" autocomplete="off" class="layui-input" id="phoneNumber">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">邮箱</label>
        <div class="layui-input-inline">
            <input type="text" name="email" placeholder="请输入邮箱地址" autocomplete="off" class="layui-input" id="email">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="editButton">修改</button>
            <button id="cancelEdit" class="layui-btn layui-btn-primary">取消</button>
        </div>
    </div>
    </div>
</form>
<div class="layui-btn-group" id="toolBarButton" style="display: none">
    <button type="button" class="layui-btn" lay-event="add"><i class="layui-icon layui-icon-addition"></i>添加</button>
    <button type="button" class="layui-btn layui-btn-danger" lay-event="del"><i class="layui-icon layui-icon-delete"></i>删除</button>
    <!--    <button type="button" class="layui-btn" onclick="window.location.href='logout'"><i class="layui-icon layui-icon-logout"></i>注销</button>-->
    <!--    <button type="button" class="layui-btn" onclick="window.location.href='toIndex'"><i class="layui-icon layui-icon-home"></i>首页</button>-->
</div>
<table class="layui-hide" id="demo"  lay-filter="test"></table>
</body>


<!--表单监听事件-->
<script>
    layui.use(['form', 'layedit', 'laydate'], function(){
        var form = layui.form
            ,layer = layui.layer
            ,layedit = layui.layedit
            ,laydate = layui.laydate;
        //添加表单和编辑表单处角色下拉框数据加载
        $(function () {
            $.ajax({
                url : '/roleSelect',
                dataType : 'json',
                data : {'status' : 0},//查询状态为0的所有角色
                type : 'post',
                success : function (data) {
                    //遍历data
                    $.each(data, function (i, item) {//i表示要下标，item表示该下标的值
                        //添加一项
                        $('#roleSelect').append(new Option(item['roleName']),item['roleName']);//Option的第一个参数表示下拉框选项的真实值，第二参数表示展示内容
                        $('#roleEditFormSelect').append(new Option(item['roleName']),item['roleName']);
                    });
                    form.render('select');//最后重新渲染一下下拉框
                }
            })
        })
        //添加表单处部门下拉框数据加载
        $(function () {
            $.ajax({
                url : '/system/deptSelect',
                dataType : 'json',
                data : {'status' : 0},//查询状态为0的所有角色
                type : 'post',
                success : function (data) {
                    //遍历data
                    $.each(data, function (i, item) {//i表示要下标，item表示该下标的值
                        //添加一项
                        $('#deptSelect').append(new Option(item['deptName']),item['deptName']);//Option的第一个参数表示下拉框选项的真实值，第二参数表示展示内容
                        $('#deptEditFormSelect').append(new Option(item['deptName']),item['deptName']);
                    });
                    form.render('select');//最后重新渲染一下下拉框
                }
            })
        })
        //监听添加用户提交
        form.on('submit(insertButton)', function(data){
            var dataList = data.field;
            if (!dataList.hasOwnProperty("status")){
                dataList['status'] = "off";
            }
            // console.log(dataList);
            $.ajax({
                type : 'POST',
                url : "/insertUser",
                data : {"loginName" : dataList['loginName'],"userName" : dataList['userName'],"password" : dataList['password'],"roleName" : dataList['roleName'],"deptName" : dataList['deptName'],"status" : dataList['status'],"sex" : dataList['sex'],"phoneNumber" : dataList['phoneNumber'],"email" : dataList['email']},
                success : function (result) {
                    if (result.code == 0){
                        layer.closeAll();
                        resetInsertPage();
                        layer.msg(result.message);
                    }
                    else {
                        layer.closeAll();
                        resetInsertPage();
                        layer.msg(result.message);
                        myTable.reload();
                    }
                }
            });
            return false;
        });

        //监听编辑用户提交
        form.on('submit(editButton)', function(data){
            var dataList = data.field;
            if (!dataList.hasOwnProperty("status")){
                dataList['status'] = "off";
            }
            // console.log(dataList);
            $.ajax({
                type : 'POST',
                url : "/updateUser",
                data : {"userId":dataList['userId'],"loginName" : dataList['loginName'],"userName" : dataList['userName'],"password" : dataList['password'],"roleName" : dataList['roleName'],"deptName" : dataList['deptName'],"status" : dataList['status'],"sex" : dataList['sex'],"phoneNumber" : dataList['phoneNumber'],"email" : dataList['email']},
                success : function (result) {
                    if (result.code == 0){
                        layer.closeAll();
                        resetEditPage();
                        layer.msg(result.message);
                    }
                    else {
                        layer.closeAll();
                        resetEditPage();
                        layer.msg(result.message);
                        myTable.reload();
                    }
                }
            });
            return false;
        });

        //监听重置密码页面的取消按钮
        $('#cancelResetPassword').click(function () {
            layer.closeAll()
            return false;
        })

        //监听修改用户页面的取消按钮
        $('#cancelEdit').click(function () {
            layer.closeAll()
            return false;
        })

        //监听重置密码提交
        form.on('submit(resetPasswordButton)', function(data){
            var dataList = data.field;
            if (dataList.newPassword != dataList.password){
                //console.log(dataList);
                layer.msg("两次密码不一致");
                return false;
            }
            // console.log(dataList);
            $.ajax({
                type : 'POST',
                url : "/resetPassword",
                data : {"userId":dataList['userId'],"password" : dataList['password']},
                success : function (result) {
                    if (result.code == 0){
                        layer.closeAll();
                        resetPasswordPage();
                        layer.msg(result.message);
                    }
                    else {
                        layer.closeAll();
                        resetPasswordPage();
                        layer.msg(result.message);
                        // myTable.reload();
                    }
                }
            });
            return false;
        });
    });
</script>
<script>
    var myTable;
    layui.use('table', function(){
        var table = layui.table;

        //第一个实例
        myTable = table.render({
            elem: '#demo'
            ,height: 400
            ,with: 800
            ,url: 'userTableInfo' //数据接口
            ,page: true //开启分页
            ,limit:5
            ,limits:[5,10,15,20,25,30]
            ,toolbar:'#toolBarButton'
            ,id: "userTable"
            ,cols: [
                [ //表头
                    {field: 'checkBox', width:80, sort: true, fixed: 'left',checkbox: true}
                    ,{field: 'userId', title: '编号', width:80, sort: true, fixed: 'left'}
                    ,{field: 'loginName', title: '登录名', width:120}
                    ,{field: 'userName', title: '用户名', width:120}
                    ,{field: 'roleName', title: '角色', width:120}
                    ,{field: 'deptName', title: '部门', width:120}
                    ,{field: 'phoneNumber', title: '电话号码', width:120}
                    ,{field: 'email', title: '邮箱', width:200}
                    ,{field: 'sex', title: '性别', width:50}
                    ,{field: 'status', title: '状态', width:80,templet:function (d) {
                        if (d.status == '0'){
                            return '正常';
                        }
                        else {
                            return '受限';
                        }
                    }}
                    // ,{field: 'salt', title: '盐值', width:200}
                    ,{field: 'option',title: '操作', width:220, fixed : 'right' , toolbar: '#barDemo'}
                ]
            ]
        });

        //监听头工具栏
        table.on('toolbar(test)', function (obj) {
            var checkStatus = table.checkStatus(obj.config.id)
                ,data = checkStatus.data; //获取选中的数据
            //console.log(data);
            //var data = obj.data;
            if (obj.event === 'del'){
                if (data.length === 0){
                    layer.msg("请勾选要删除的行！");
                }
                else {
                    layer.confirm("确定要删除吗？",{
                        btn : ['确定', '取消'],
                        btn2 : function (index) {
                        }
                    },function (index) {
                        var list = [];
                        for (var i = 0;i < data.length;i++){
                            list.push(data[i].userId);
                        }
                        $.post({
                            url : "/toolbarDelete",
                            data : {list : JSON.stringify(list)},
                            success : function (result) {
                                layer.msg(result);
                                myTable.reload();
                            }
                        })
                    })
                }
            }
            else if (obj.event === 'add'){
                insertUser();
            }
        });

        //监听行工具栏tool按钮的事件
        table.on('tool(test)', function(obj){
            var data = obj.data;
            //重置按钮监听
            if(obj.event === 'reset'){
                resetPasswordPage();
                $('#resetPasswordPageUserId').val(data.userId);
                //document.getElementById("userNameP").innerText=data.userName;
                resetPassword(data);
            } else if(obj.event === 'del'){//删除按钮监听
                layer.confirm('真的删除行么', function (index) {
                    $.post({
                        url : "/toolDelete",
                        data : {"userId" : data['userId']},
                        success : function (data) {
                            layer.msg(data);
                            myTable.reload();
                        }
                    })
                })
            } else if(obj.event === 'edit'){
                var form = layui.form;
                resetEditPage();
                $('#userId').val(data.userId);
                $('#loginName').val(data.loginName);
                $('#userName').val(data.userName);
                $('#phoneNumber').val(data.phoneNumber);
                $('#email').val(data.email);
                if (data.status == '0'){
                    $('#statusCheckBox').prop("checked",true);
                    // form.render();
                }
                else {
                    $('#statusCheckBox').prop("checked",false);
                    // form.render();
                }
                if (data.sex == "男"){
                    $('#manSexEdit').attr("checked","checked");
                    $('#femaleSexEdit').removeAttr("checked","checked");
                    // form.render();
                }
                else {
                    $('#manSexEdit').removeAttr("checked","checked");
                    $('#femaleSexEdit').attr("checked","checked");
                    // form.render();
                }
                $('#roleEditFormSelect').val(data.roleName);
                $('#deptEditFormSelect').val(data.deptName);
                form.render();
                editUser(obj);
            }
        });

        //监听查询按钮事件
        $('#searchButton').on('click', function(){
            var status = $('#statusSearchSelect').val();
            var loginName = $('#searchLoginName').val();
            var phoneNumber = $('#searchPhoneNumber').val();
            // console.log(status);
            // console.log(loginName);
            // console.log(phoneNumber);
            table.reload('userTable',{
                url : "/userTableSearch"
                ,method : 'post'
                ,where : {
                    'status' :  status,
                    'loginName' : loginName,
                    'phoneNumber' : phoneNumber
                }
                ,page : {
                    curr : 1
                }
                ,limit : 5
            })
            return false;
        });
    });
</script>

<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs" lay-event="reset"><i class="layui-icon layui-icon-key"></i>重置</a>
    <a class="layui-btn layui-btn-xs" lay-event="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i class="layui-icon layui-icon-close"></i>删除</a>

    <!-- 这里同样支持 laytpl 语法，如： -->
    {{#  if(d.auth > 2){ }}
    <a class="layui-btn layui-btn-xs" lay-event="check">审核</a>
    {{#  } }}
</script>
<script>
    //表头添加按钮函数
    function insertUser() {
        //页面层
        layer.open({
            type: 1,
            title:"添加用户",
            skin: 'layui-layer-rim', //加上边框
            area: ['420px', '560px'], //宽高
            content: $('#insertFormPage') //调到新增页面
        });
    }
</script>
<script>
    //tool工具栏编辑按钮函数
    function editUser(obj) {
        var data = obj.data;
        //页面层
        layer.open({
            type: 1,
            title:"编辑用户",
            skin: 'layui-layer-rim', //加上边框
            area: ['420px', '560px'], //宽高
            content: $('#editFormPage') //调到新增页面
        });

    }
</script>
<script>
    //tool工具栏重置按钮函数
    function resetPassword(obj) {
        var data = obj;
        layer.open({
            type : 1,
            title : "(用户ID:"+data.userId + ";  登录名:"+data.loginName+";  用户名:"+data.userName+")",
            skin : 'layui-layer-rim',
            area : ['420px','300px'],
            content : $('#resetPasswordFormPage')
        })
    }
</script>
<script>
    function logout() {
        layer.confirm("确定退出吗？",{
            btn : ['确定','取消'],
            btn2 : function () {
            },
        },function () {
            //console.log("退出");
            location.href = "/logout";
            // $.ajax({
            //     url : "/logout"
            // })
        })
    }
</script>

<!--表单的提交触发函数-->
<script>
    function submit(callback){
        document.getElementById("insertFormPage").submit();
        document.getElementById("editFormPage").submit();
        document.getElementById("resetPasswordFormPage").submit();
        callback();
    }
    function resetInsertPage(){
        document.getElementById("insertFormPage").reset();
    }
    function resetPasswordPage(){
        document.getElementById("resetPasswordFormPage").reset();
    }
    function resetEditPage(){
        document.getElementById("editFormPage").reset();
    }
</script>
<script>
    function cancelEdit() {
        // parent.layer.close(index);
    }
</script>
</html>