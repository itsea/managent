<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Role Table</title>
    <script th:src="@{/js/jquery-3.4.1.js}"></script>
    <script th:src="@{/layui/layui.js}"></script>
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}">
</head>
<body>

<!--搜索查询表单-->
<!--<form class="layui-form" id="roleSearchForm" action="">-->
<!--    <br>-->
<!--    <div class="layui-form-item">-->
<!--        <label class="layui-form-label">状态:</label>-->
<!--        <div class="layui-input-inline">-->
<!--            <select name="statusSearchSelect" id="statusSearchSelect">-->
<!--                <option value="" selected="selected">所有</option>-->
<!--                <option value="0">正常</option>-->
<!--                <option value="1">受限</option>-->
<!--            </select>-->
<!--        </div>-->
<!--        <div class="layui-inline">-->
<!--            <label class="layui-form-label">角色名:</label>-->
<!--            <div class="layui-input-inline">-->
<!--                <input type="text" id="searchLoginName" name="searchLoginName" lay-verify="" autocomplete="off" class="layui-input">-->
<!--            </div>-->
<!--        </div>-->
<!--        <div class="layui-inline">-->
<!--            <label class="layui-form-label">权限字符:</label>-->
<!--            <div class="layui-input-inline">-->
<!--                <input id="searchPhoneNumber" type="text" name="searchPhoneNumber" lay-verify="" autocomplete="off" class="layui-input">-->
<!--            </div>-->
<!--        </div>-->
<!--        <div class="layui-inline">-->
<!--            <div class="layui-input-inline">-->
<!--                <button id="searchButton" class="layui-btn"><i class="layui-icon layui-icon-search"></i>查询</button>-->
<!--                <button type="reset" class="layui-btn layui-btn-primary"><i class="layui-icon layui-icon-refresh-1"></i>重置</button>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--</form>-->

<hr>

<!--数据权限表单-->
<form class="layui-form layui-form-pane" id="resetPasswordFormPage" action="" style="display: none;text-align: center" method="post">
    <br><br>
    <div class="layui-inline">
        <div class="layui-form-item" style="display: none" >
            <label class="layui-form-label">角色Id</label>
            <div class="layui-input-inline">
                <input id="dataRightRoleId" type="text" name="roleId" placeholder="请输入角色Id" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">角色名称</label>
            <div class="layui-input-inline">
                <input type="text" name="roleName" required lay-verify="required" placeholder="请输入角色名称" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">权限字符</label>
            <div class="layui-input-inline">
                <input type="text" name="roleKey" required lay-verify="required" placeholder="请输入权限字符" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="resetPasswordButton">确定</button>
                <button id="cancelResetPassword" class="layui-btn layui-btn-primary">取消</button>
            </div>
        </div>
    </div>
</form>

<!--插入角色表单-->
<form class="layui-form layui-form-pane" id="insertFormPage" action="" style="display: none;text-align: center" method="post">
    <br><br>
    <div class="layui-inline">
        <div class="layui-form-item">
            <label class="layui-form-label">角色名称</label>
            <div class="layui-input-inline">
                <input type="text" name="roleName" required lay-verify="required" placeholder="请输入角色名" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">权限字符</label>
            <div class="layui-input-inline">
                <input type="text" name="roleKey" required lay-verify="required" placeholder="请输入权限字符" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">显示顺序</label>
            <div class="layui-input-inline">
                <input type="text" name="sort" required lay-verify="required|number" placeholder="请输入显示顺序" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">状态</label>
            <div class="layui-input-block">
                <input type="checkbox" name="status" lay-skin="switch" checked="checked" lay-text="正常|受限">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">菜单权限</label>
            <div class="layui-input-block">
                <div id="test12" class="demo-tree-more"></div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="insertButton">添加</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </div>
</form>

<!--编辑角色表单-->
<form class="layui-form layui-form-pane" id="editFormPage" action="" style="display: none;text-align: center" method="post" name="editFormPage">
    <br><br>
    <div class="layui-inline">
        <div class="layui-form-item" style="display: none">
            <label class="layui-form-label">角色Id</label>
            <div class="layui-input-inline">
                <input id="roleId" type="text" name="roleId" placeholder="请输入角色Id" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">角色名称</label>
            <div class="layui-input-inline">
                <input id="roleName" type="text" name="roleName" required lay-verify="required" placeholder="请输入角色名称" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">权限字符</label>
            <div class="layui-input-inline">
                <input id="roleKey" type="text" name="roleKey" required lay-verify="required" placeholder="请输入权限字符" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">显示顺序</label>
            <div class="layui-input-inline">
                <input id="roleSort" type="text" name="roleSort" required lay-verify="required" placeholder="请输入显示顺序" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">状态</label>
            <div class="layui-input-block" pane>
                <input type="checkbox" name="status" lay-skin="switch" id="statusCheckBox" lay-text="正常|受限">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="editButton">修改</button>
                <button id="cancelEdit" class="layui-btn layui-btn-primary">取消</button>
            </div>
        </div>
    </div>
</form>
<div class="layui-btn-group" id="toolBarButton" style="display: none">
    <button type="button" class="layui-btn" lay-event="add"><i class="layui-icon layui-icon-addition"></i>添加</button>
    <button type="button" class="layui-btn layui-btn-danger" lay-event="del"><i class="layui-icon layui-icon-delete"></i>删除</button>
    <!--    <button type="button" class="layui-btn" onclick="window.location.href='logout'"><i class="layui-icon layui-icon-logout"></i>注销</button>-->
    <!--    <button type="button" class="layui-btn" onclick="window.location.href='toIndex'"><i class="layui-icon layui-icon-home"></i>首页</button>-->
</div>
<table class="layui-hide" id="demo"  lay-filter="test"></table>
</body>


<!--表单监听事件-->
<script>
    layui.use(['form', 'layedit', 'laydate'], function(){
        var form = layui.form
            ,layer = layui.layer
            ,layedit = layui.layedit
            ,laydate = layui.laydate;

        //监听添加用户提交
        form.on('submit(insertButton)', function(data){
            resetInsertPage();
            var dataList = data.field;
            if (!dataList.hasOwnProperty("status")){
                dataList['status'] = "off";
            }
            console.log(dataList);
            $.ajax({
                type : 'POST',
                url : "/insertRole",
                data : {"roleName" : dataList['roleName'],"roleKey" : dataList['roleKey'],"sort" : dataList['sort'],"status" : dataList['status']},
                success : function (result) {
                    if (result.code == 0){
                        layer.closeAll();
                        resetInsertPage();
                        layer.msg(result.message);
                    }
                    else {
                        layer.closeAll();
                        resetInsertPage();
                        layer.msg(result.message);
                        myTable.reload();
                    }
                }
            });
            return false;
        });

        //监听编辑角色提交
        form.on('submit(editButton)', function(data){
            var dataList = data.field;
            if (!dataList.hasOwnProperty("status")){
                dataList['status'] = "off";
            }
            // console.log(dataList);
            $.ajax({
                type : 'POST',
                url : "/updateRole",
                data : {"roleId":dataList['roleId'],"roleName" : dataList['roleName'],"roleKey" : dataList['roleKey'],"roleSort" : dataList['roleSort'],"status" : dataList['status']},
                success : function (result) {
                    if (result.code == 0){
                        layer.closeAll();
                        resetEditPage();
                        layer.msg(result.message);
                    }
                    else {
                        layer.closeAll();
                        resetEditPage();
                        layer.msg(result.message);
                        console.log("ok");
                        myTable.reload();
                    }
                }
            });
            return false;
        });


        //监听修改用户页面的取消按钮
        $('#cancelEdit').click(function () {
            layer.closeAll()
            return false;
        })

    });
</script>
<script>
    var myTable;
    layui.use('table', function(){
        var table = layui.table;

        //第一个实例
        myTable = table.render({
            elem: '#demo'
            ,height: 400
            ,with: 800
            ,url: 'roleTableInfo' //数据接口
            ,page: false
            ,toolbar:'#toolBarButton'
            ,id: "roleTable"
            ,cols: [
                [ //表头
                    {field: 'checkBox', width:80, sort: true, fixed: 'left',checkbox: true}
                    ,{field: 'roleId', title: '角色编号', width:160, sort: true, fixed: 'left'}
                    ,{field: 'roleName', title: '角色名称', width:200, sort: true, fixed: 'left'}
                    ,{field: 'roleKey', title: '权限字符', width:200}
                    ,{field: 'roleSort', title: '显示顺序', width:120}
                    ,{field: 'status', title: '状态', width:200,templet:function (d) {
                        if (d.status == '0'){
                            return '正常';
                        }
                        else {
                            return '受限';
                        }
                    }}
                    // ,{field: 'salt', title: '盐值', width:200}
                    ,{field: 'option',title: '操作', width:250, fixed : 'right' , toolbar: '#barDemo'}
                ]
            ]
        });

        //监听头工具栏
        table.on('toolbar(test)', function (obj) {
            var checkStatus = table.checkStatus(obj.config.id)
                ,data = checkStatus.data; //获取选中的数据
            //console.log(data);
            //var data = obj.data;
            if (obj.event === 'del'){
                if (data.length === 0){
                    layer.msg("请勾选要删除的行！");
                }
                else {
                    layer.confirm("确定要删除吗？",{
                        btn : ['确定', '取消'],
                        btn2 : function (index) {
                        }
                    },function (index) {
                        var list = [];
                        for (var i = 0;i < data.length;i++){
                            list.push(data[i].roleId);
                        }
                        $.post({
                            url : "/toolbarDeleteRole",
                            data : {list : JSON.stringify(list)},
                            success : function (result) {
                                layer.msg(result);
                                myTable.reload();
                            }
                        })
                    })
                }
            }
            else if (obj.event === 'add'){
                insertRole();
            }
        });

        //监听行工具栏tool按钮的事件
        table.on('tool(test)', function(obj){
            var data = obj.data;
            //重置按钮监听
            if(obj.event === 'reset'){
                resetPasswordPage();
                $('#resetPasswordPageRoleId').val(data.roleId);
                resetPassword(data);
            } else if(obj.event === 'del'){//删除按钮监听
                layer.confirm('真的删除行么', function (index) {
                    $.post({
                        url : "/toolDeleteRole",
                        data : {"roleId" : data['roleId']},
                        success : function (data) {
                            layer.msg(data);
                            myTable.reload();
                        }
                    })
                })
            } else if(obj.event === 'edit'){
                var form = layui.form;
                resetEditPage();
                $('#roleId').val(data.roleId);
                $('#roleName').val(data.roleName);
                $('#roleKey').val(data.roleKey);
                $('#roleSort').val(data.roleSort);
                if (data.status == '0'){
                    $('#statusCheckBox').prop("checked",true);
                    // form.render();
                }
                else {
                    $('#statusCheckBox').prop("checked",false);
                    // form.render();
                }
                form.render();
                editRole(obj);
            }
        });

        // //监听查询按钮事件
        // $('#searchButton').on('click', function(){
        //     var status = $('#statusSearchSelect').val();
        //     var loginName = $('#searchLoginName').val();
        //     var phoneNumber = $('#searchPhoneNumber').val();
        //     // console.log(status);
        //     // console.log(loginName);
        //     // console.log(phoneNumber);
        //     table.reload('userTable',{
        //         url : "/userTableSearch"
        //         ,method : 'post'
        //         ,where : {
        //             'status' :  status,
        //             'loginName' : loginName,
        //             'phoneNumber' : phoneNumber
        //         }
        //         ,page : {
        //             curr : 1
        //         }
        //         ,limit : 5
        //     })
        //     return false;
        // });
    });
</script>

<script type="text/html" id="barDemo">
<!--    <a class="layui-btn layui-btn-xs" lay-event="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>-->
    <a class="layui-btn layui-btn-xs" lay-event="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i class="layui-icon layui-icon-close"></i>删除</a>

    <!-- 这里同样支持 laytpl 语法，如： -->
    {{#  if(d.auth > 2){ }}
    <a class="layui-btn layui-btn-xs" lay-event="check">审核</a>
    {{#  } }}
</script>
<script>
    //表头添加按钮函数
    function insertRole() {
        //页面层
        layer.open({
            type: 1,
            title:"添加角色",
            skin: 'layui-layer-rim', //加上边框
            area: ['420px', '420px'], //宽高
            content: $('#insertFormPage') //调到新增页面
        });
    }
</script>
<script>
    //tool工具栏编辑按钮函数
    function editRole(obj) {
        var data = obj.data;
        //页面层
        layer.open({
            type: 1,
            title:"编辑角色",
            skin: 'layui-layer-rim', //加上边框
            area: ['420px', '420px'], //宽高
            content: $('#editFormPage') //调到新增页面
        });

    }
</script>
<script>
    //tool工具栏重置按钮函数
    function resetPassword(obj) {
        var data = obj;
        layer.open({
            type : 1,
            title : "(角色编号:"+data.roleId + ";  角色名称:"+data.roleName+";  权限字符:"+data.roleKey+")",
            skin : 'layui-layer-rim',
            area : ['420px','300px'],
            content : $('#resetPasswordFormPage')
        })
    }
</script>
<script>
    function logout() {
        layer.confirm("确定退出吗？",{
            btn : ['确定','取消'],
            btn2 : function () {
            },
        },function () {
            //console.log("退出");
            location.href = "/logout";
            // $.ajax({
            //     url : "/logout"
            // })
        })
    }
</script>

<!--表单的提交触发函数-->
<script>
    function submit(callback){
        document.getElementById("insertFormPage").submit();
        document.getElementById("editFormPage").submit();
        document.getElementById("resetPasswordFormPage").submit();
        callback();
    }
    function resetInsertPage(){
        document.getElementById("insertFormPage").reset();
    }
    function resetPasswordPage(){
        document.getElementById("resetPasswordFormPage").reset();
    }
    function resetEditPage(){
        document.getElementById("editFormPage").reset();
    }
</script>
<script>
    function cancelEdit() {
        // parent.layer.close(index);
    }
</script>
<script>
    $(function () {
        layui.use(['tree', 'util'], function() {
            var tree = layui.tree
                , layer = layui.layer
                , util = layui.util

            $.ajax({
                url: 'selectAllMenu',//地址
                dataType: 'json',//数据类型
                type: 'GET',//类型
                //请求成功
                success: function (result) {
                    //基本演示
                    tree.render({
                        elem: '#test12'
                        , data: result
                        , showCheckbox: true  //是否显示复选框
                        , id: 'demoId1'
                        , isJump: true //是否允许点击节点时弹出新窗口跳转
                        , click: function (obj) {
                            var data = obj.data;  //获取当前点击的节点数据
                            layer.msg('状态：' + obj.state + '<br>节点数据：' + JSON.stringify(data));
                        }
                    });
                }
            });
        });
    })
</script>
</html>